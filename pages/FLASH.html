<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revision Flashcards</title>
    
    <link rel="icon" type="image/x-icon" href="../assets/Main Favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../assets/styles.css">
    
    <style>
        /* ------------------- */
        /* --- Variables --- */
        /* ------------------- */
        :root {
            --max-width: 900px;
        }

        /* ------------------- */
        /* --- Main Content --- */
        /* ------------------- */
        main {
            flex-grow: 1;
            padding: 32px 24px;
            width: 100%;
            max-width: var(--max-width);
            margin: 0 auto;
        }

        .page-intro { text-align: center; margin-bottom: 32px; }
        .page-intro h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 8px; }
        .page-intro p { color: var(--text-secondary); font-size: 0.95rem; }

        /* ------------------- */
        /* --- Selection Card --- */
        /* ------------------- */
        .controls-container {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 32px;
            max-width: 600px;
            margin: 0 auto;
            display: flex; flex-direction: column; gap: 20px;
        }

        label {
            display: block; margin-bottom: 8px;
            font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;
        }

        select {
            width: 100%; padding: 10px 12px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit; font-size: 0.95rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1a1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        select:focus { outline: none; border-color: var(--accent-color); }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
        select option { background-color: var(--bg-input); color: var(--text-primary); padding: 10px; }

        /* Checkbox for shuffle */
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 10px; margin-top: -10px;
        }
        .checkbox-wrapper input {
            width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-color);
        }
        .checkbox-wrapper label { margin: 0; cursor: pointer; }

        button {
            width: 100%; padding: 10px 20px;
            font-size: 0.9rem; font-weight: 500;
            border-radius: 4px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s;
        }
        
        #start-btn {
            background-color: var(--accent-color); color: #fff; margin-top: 10px;
        }
        #start-btn:hover { background-color: var(--accent-hover); }
        #start-btn:disabled { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-tertiary); cursor: not-allowed; }

        /* ------------------- */
        /* --- Flashcard Game --- */
        /* ------------------- */
        #game-interface { display: none; max-width: 700px; margin: 0 auto; }
        
        .flashcard-scene {
            height: 400px;
            perspective: 1000px;
            margin-bottom: 16px; 
            cursor: pointer;
        }

        .flashcard {
            width: 100%; height: 100%;
            position: relative;
            transition: transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }

        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
            
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .flashcard-front { z-index: 2; }
        
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: var(--bg-input);
            border-color: var(--border-active);
        }

        .card-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-tertiary); margin-bottom: 24px; font-weight: 600; flex-shrink: 0;
        }

        .card-content {
            font-size: 1.25rem; font-weight: 500; color: var(--text-primary);
            line-height: 1.6;
            overflow-y: auto; /* Scroll long text */
            max-height: 100%;
            width: 100%;
        }

        /* Scrollbar styling for card content */
        .card-content::-webkit-scrollbar { width: 6px; }
        .card-content::-webkit-scrollbar-track { background: transparent; }
        .card-content::-webkit-scrollbar-thumb { background-color: var(--border-active); border-radius: 3px; }

        .tap-hint {
            margin-top: auto; font-size: 0.8rem; color: var(--text-tertiary); flex-shrink: 0; padding-top: 10px;
        }

        .game-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 24px;
        }

        .nav-btn { width: auto; background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .nav-btn:hover { background-color: var(--bg-input); border-color: var(--text-secondary); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #next-btn {
            background-color: var(--accent-color); color: white; border-color: var(--accent-color);
        }
        #next-btn:hover { background-color: var(--accent-hover); }
        #next-btn:disabled { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-tertiary); }

        #quit-btn {
            background: none; border: none; color: var(--text-tertiary);
            text-decoration: none; font-size: 0.85rem; margin-top: 32px; width: auto;
        }
        #quit-btn:hover { color: var(--text-primary); text-decoration: underline; }

        #status-msg {
            text-align: center; font-size: 0.85rem; color: var(--text-secondary);
            margin-top: 16px; display: none;
        }

        .shortcut-hint {
            text-align: center; font-size: 0.75rem; color: var(--text-tertiary); margin-top: 15px;
        }

        /* Footer */
        .site-footer {
            border-top: 1px solid var(--border-color);
            padding: 40px 0; margin-top: auto;
            color: var(--text-tertiary); font-size: 0.85rem; text-align: center;
            background-color: var(--bg-body);
        }

        /* Mobile */
        @media (max-width: 768px) {
            .nav-menu { display: none; }
            .shortcut-hint { display: none; } /* Hide keyboard hints on mobile */
        }
    </style>
</head>
<body>

<header class="site-header">
    <div class="container header-inner">
        <a href="../index.html" class="logo">StudyNest</a>
        <nav class="nav-menu">
            <a href="../index.html">Home</a>
            <a href="APR.html">Past Papers</a>
            <a href="FLASH.html" class="active">Flashcards</a>
            <a href="syllabus.html">Geography Case Studies</a>
            <a href="maker.html">Create Deck</a>
            <a href="login.html">Login</a>
        </nav>
        <button class="mobile-toggle" aria-label="Toggle Menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="mobile-menu-overlay" id="mobile-menu">
        <a href="../index.html">Home</a>
        <a href="APR.html">Past Papers</a>
        <a href="FLASH.html" class="active-link">Flashcards</a>
        <a href="syllabus.html">Geography Case Studies</a>
        <a href="maker.html">Create Deck</a>
        <a href="login.html">Login</a>
    </div>
</header>

<main>
    <div class="page-intro">
        <h1>Revision Flashcards</h1>
        <p>Select a course pack to begin your session.</p>
    </div>

    <!-- SETUP INTERFACE -->
    <div id="setup-interface" class="controls-container">
        
        <div>
            <label for="course-select">1. Select Course Pack</label>
            <select id="course-select">
                <option value="" disabled selected>Choose a Course...</option>
                <option value="CUSTOM" style="font-weight: 600; color: var(--accent-color);">★ My Custom Decks (Database)</option>
                <option value="../data/geography-data.json">Geography (A Level)</option>
            </select>
        </div>

        <div>
            <label for="subject-select">2. Module / Subject</label>
            <select id="subject-select" disabled>
                <option value="" disabled selected>Select a Module...</option>
            </select>
        </div>

        <div>
            <label for="topic-select">3. Specific Topic</label>
            <select id="topic-select" disabled>
                <option value="" disabled selected>Select a Topic...</option>
            </select>
        </div>

        <div class="checkbox-wrapper">
            <input type="checkbox" id="shuffle-check">
            <label for="shuffle-check">Shuffle Cards</label>
        </div>

        <button id="start-btn" disabled>Start Practicing</button>
        
        <div id="status-msg">Loading...</div>
    </div>

    <!-- GAME INTERFACE -->
    <div id="game-interface">
        
        <div class="flashcard-scene" id="flashcard-scene">
            <div class="flashcard" id="flashcard">
                <!-- Front -->
                <div class="flashcard-face flashcard-front">
                    <div class="card-label">Question</div>
                    <div id="card-front-text" class="card-content">...</div>
                    <div class="tap-hint">Tap card or Spacebar to flip</div>
                </div>
                <!-- Back -->
                <div class="flashcard-face flashcard-back">
                    <div class="card-label">Answer</div>
                    <div id="card-back-text" class="card-content">...</div>
                </div>
            </div>
        </div>

        <div class="game-controls">
            <button id="prev-btn" class="nav-btn">Previous (Left)</button>
            <span id="progress-text" style="color: var(--text-secondary); font-size: 0.9rem;">0 / 0</span>
            <button id="next-btn" class="nav-btn">Next (Right)</button>
        </div>

        <p class="shortcut-hint">Keyboard Shortcuts: Space to Flip • Arrows to Navigate</p>

        <div style="text-align:center;">
            <button id="quit-btn">← Return to selection</button>
        </div>
    </div>
</main>

<!-- Footer removed per user request (kept empty originally) -->

<!-- FIREBASE & LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA2G_D9RCX5DfMxp2Mkri03AivhM_GNw5c",
    authDomain: "actiari-fixed.firebaseapp.com",
    projectId: "actiari-fixed",
    storageBucket: "actiari-fixed.firebasestorage.app",
    messagingSenderId: "154407363342",
    appId: "1:154407363342:web:7e3b21f8189d556afaed5f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- VARIABLES ---
let activeData = {}; 
let userCustomDecks = {}; 
let currentDeck = [];
let currentIndex = 0;
let isGameActive = false;

// --- ELEMENTS ---
const courseSelect = document.getElementById('course-select');
const subjectSelect = document.getElementById('subject-select');
const topicSelect = document.getElementById('topic-select');
const startBtn = document.getElementById('start-btn');
const statusMsg = document.getElementById('status-msg');
const flashcard = document.getElementById('flashcard');
const shuffleCheck = document.getElementById('shuffle-check');

// --- 1. LOAD DATABASE (CUSTOM DECKS) ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        statusMsg.style.display = 'block';
        statusMsg.style.color = '#2563eb';
        statusMsg.textContent = "Checking for custom decks...";
        
        try {
            const q = query(collection(db, "decks"), where("userId", "==", user.uid));
            const snap = await getDocs(q);
            
            if(!snap.empty) {
                userCustomDecks = {}; 
                snap.forEach(doc => {
                    const d = doc.data();
                    const sub = d.subject || "My Custom Packs";
                    if(!userCustomDecks[sub]) userCustomDecks[sub] = {};
                    userCustomDecks[sub][d.title] = d.cards;
                });
                
                statusMsg.textContent = "✓ Custom decks loaded.";
                statusMsg.style.color = "#10b981";
                
                if(courseSelect.value === "CUSTOM") {
                    activeData = { ...userCustomDecks };
                    refreshSubjects();
                }
            } else {
                statusMsg.textContent = "No custom decks found.";
            }
        } catch (e) {
            console.error(e);
            statusMsg.style.color = "#ef4444";
            statusMsg.textContent = "Error loading custom decks.";
        }
    } else {
        statusMsg.style.display = 'block';
        statusMsg.textContent = "Log in to see custom decks.";
    }
});

// --- 2. COURSE SELECTION HANDLER ---
courseSelect.addEventListener('change', async (e) => {
    const val = e.target.value;
    
    // Reset UI
    activeData = {};
    subjectSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
    topicSelect.innerHTML = '<option value="" disabled selected>Select Topic...</option>';
    subjectSelect.disabled = true;
    topicSelect.disabled = true;
    startBtn.disabled = true;

    // A. Custom
    if (val === "CUSTOM") {
        if (Object.keys(userCustomDecks).length === 0) {
            alert("No custom decks found. Please create one in the 'Create Deck' page or wait for login.");
            subjectSelect.innerHTML = '<option value="" disabled selected>No decks found</option>';
            return;
        }
        activeData = { ...userCustomDecks };
        refreshSubjects();
        return;
    }

    // B. JSON File
    try {
        const res = await fetch(val);
        if(!res.ok) throw new Error("File not found");
        const json = await res.json();
        activeData = json; 
        refreshSubjects();
    } catch (err) {
        console.error(err);
        alert("Could not load course file. Make sure '" + val + "' exists.");
        subjectSelect.innerHTML = '<option value="" disabled selected>Error loading file</option>';
    }
});

function refreshSubjects() {
    subjectSelect.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
    subjectSelect.disabled = false;
    const subjects = Object.keys(activeData).sort();
    subjects.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        subjectSelect.appendChild(opt);
    });
}

subjectSelect.addEventListener('change', (e) => {
    const sub = e.target.value;
    topicSelect.innerHTML = '<option value="" disabled selected>Select a Topic...</option>';
    topicSelect.disabled = false;
    startBtn.disabled = true;

    if(activeData[sub]) {
        const topics = Object.keys(activeData[sub]).sort();
        topics.forEach(topic => {
            const opt = document.createElement('option');
            opt.value = topic;
            opt.textContent = topic;
            topicSelect.appendChild(opt);
        });
    }
});

topicSelect.addEventListener('change', () => {
    startBtn.disabled = false;
});

// --- SHUFFLE FUNCTION ---
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// --- 3. START GAME ---
startBtn.addEventListener('click', () => {
    const sub = subjectSelect.value;
    const top = topicSelect.value;
    
    if(activeData[sub] && activeData[sub][top]) {
        // Create a copy of the deck
        let deckToLoad = [...activeData[sub][top]];
        
        if (deckToLoad.length === 0) {
            alert("This deck has no cards!");
            return;
        }

        // Apply shuffle if checked
        if (shuffleCheck.checked) {
            deckToLoad = shuffleArray(deckToLoad);
        }

        currentDeck = deckToLoad;
        currentIndex = 0;
        isGameActive = true;
        loadCard(0);
        
        document.getElementById('setup-interface').style.display = 'none';
        document.getElementById('game-interface').style.display = 'block';
        document.querySelector('.page-intro').style.display = 'none';
    }
});

// --- 4. GAME LOGIC ---
document.getElementById('quit-btn').addEventListener('click', () => {
    document.getElementById('setup-interface').style.display = 'flex';
    document.getElementById('game-interface').style.display = 'none';
    document.querySelector('.page-intro').style.display = 'block';
    flashcard.classList.remove('is-flipped');
    isGameActive = false;
});

function loadCard(i) {
    // Prevent index out of bounds
    if (i < 0 || i >= currentDeck.length) return;

    flashcard.classList.remove('is-flipped'); // Always reset to front
    
    // Slight delay to allow flip animation to reset if rapidly clicking
    setTimeout(() => {
        const card = currentDeck[i];
        document.getElementById('card-front-text').textContent = card.q;
        document.getElementById('card-back-text').textContent = card.a;
        document.getElementById('progress-text').textContent = `${i+1} / ${currentDeck.length}`;
        
        document.getElementById('prev-btn').disabled = (i === 0);
        document.getElementById('next-btn').disabled = (i === currentDeck.length - 1);
    }, 150);
}

function flipCard() {
    flashcard.classList.toggle('is-flipped');
}

function nextCard() {
    if(currentIndex < currentDeck.length-1) loadCard(++currentIndex);
}

function prevCard() {
    if(currentIndex > 0) loadCard(--currentIndex);
}

// --- EVENT LISTENERS ---
document.getElementById('flashcard-scene').addEventListener('click', flipCard);
document.getElementById('next-btn').addEventListener('click', (e) => { e.target.blur(); nextCard(); });
document.getElementById('prev-btn').addEventListener('click', (e) => { e.target.blur(); prevCard(); });

// Keyboard Listeners
document.addEventListener('keydown', (e) => {
    if (!isGameActive) return; // Only listen when game is running

    if (e.code === 'Space') {
        e.preventDefault(); // Stop page scrolling
        flipCard();
    } else if (e.code === 'ArrowRight') {
        nextCard();
    } else if (e.code === 'ArrowLeft') {
        prevCard();
    }
});
</script>

<script>
    const mobileBtn = document.querySelector('.mobile-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const body = document.body;
    let isMenuOpen = false;

    // SVG Icons
    const hamburgerIcon = `
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>`;
    
    const closeIcon = `
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>`;

    mobileBtn.addEventListener('click', () => {
        isMenuOpen = !isMenuOpen;
        mobileMenu.classList.toggle('active');
        body.classList.toggle('menu-open');
        const svg = mobileBtn.querySelector('svg');
        svg.innerHTML = isMenuOpen ? closeIcon : hamburgerIcon;
    });
</script>
<!-- Firebase auth toggle for nav Login -> Logout -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
    const loginLinks = document.querySelectorAll('a[href="login.html"]');
    if (user) {
        loginLinks.forEach(link => {
            link.textContent = 'Logout';
            link.href = '#';
            link.style.color = '#ef4444';
            link.onclick = async (e) => { e.preventDefault(); await signOut(auth); window.location.reload(); };
        });
    } else {
        loginLinks.forEach(link => {
            link.textContent = 'Login';
            link.href = 'login.html';
            link.style.color = '';
            link.onclick = null;
        });
    }
});
</script>
</body>
</html>